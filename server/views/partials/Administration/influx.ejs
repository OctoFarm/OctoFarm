<% let base = '..' %>
<% let infoAlert = base + '/octofarm-title-info.ejs' %>
<% let checkBox = base + '/octofarm-checkbox.ejs' %>
<% let alert = base + '/octofarm-alert.ejs' %>
<% let textInput = base + '/octofarm-text-input.ejs' %>

<div class="row">
    <div class="col-12">
        <%- include(alert, {
        alertType: "secondary",
        alertMessage: "Settings relating to the inbuilt InfluxDB Export. This is mainly for power option users who know how to utilise these tools themselves and want to get more out of the data stored inside OctoFarm."
        })
        %>
    </div>
    <div class="col-12 col-md-8 col-lg-7">
        <%- include(infoAlert, {
        title: "Settings",
        infoID: "infoInfluxSetup",
        infoText: "Below you can enter your influx database settings. OctoFarm expects influx to be setup before activating but you can save your settings and active at a later date."
        })
        %>
        <div class="row">
            <div class="col-12 col-md-4 col-lg-4">
                <%- include(checkBox, {
                checkboxID: "infoInfluxActivate",
                checkboxChecked: serverSettings.influxExport.active,
                checkboxLabel: "Activate Export",
                checkboxOnLabel: "Influx export is activated",
                checkboxOffLabel: "Influx export is de-activated"
                })
                %>
                <hr>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <%- include(infoAlert, {
                title: "Host Information",
                infoID: "infoPortNumber",
                infoText: "Your connection details for the influx database server. Leave username and password blank if you don't have authentication enabled."
                })
                %>
            </div>
            <div class="col-12 col-md-6">
                <%- include(textInput, {
                inputID: "infHostIP",
                inputType: "text",
                inputTag: "IP",
                inputStep: 1,
                inputPlaceholder: "x.x.x.x",
                inputValue: serverSettings.influxExport.host
                })
                %>
                <hr>
            </div>
            <div class="col-12 col-md-6">
                <%- include(textInput, {
                inputID: "infHostPort",
                inputType: "number",
                inputTag: "Port",
                inputStep: 1,
                inputPlaceholder: 8086,
                inputValue: serverSettings.influxExport.port
                })
                %>
                <hr>
            </div>
            <div class="col-12 col-md-6">
                <%- include(textInput, {
                inputID: "infPassword",
                inputType: "text",
                inputTag: "Username",
                inputPlaceholder: serverSettings.influxExport.username,
                inputValue: serverSettings.influxExport.username
                })
                %>
                <hr>
            </div>
            <div class="col-12 col-md-6">
                <%- include(textInput, {
                inputID: "infUsername",
                inputType: "text",
                inputTag: "Password",
                inputStep: 1,
                inputPlaceholder:  serverSettings.influxExport.password,
                inputValue: serverSettings.influxExport.password
                })
                %>
                <hr>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <%- include(infoAlert, {
                title: "Database Information",
                infoID: "infoPortNumber",
                infoText: "Information on what database you'd like to use. OctoFarm will automatically create your database for you if it doesn't exist."
                })
                %>
            </div>
            <div class="col-12">
                <%- include(textInput, {
                inputID: "infDatabase",
                inputType: "text",
                inputTag: "Name",
                inputPlaceholder: "OctoFarmExport",
                inputValue: serverSettings.influxExport.database
                })
                %>
                <hr>
            </div>
            <div class="col-12">
                <%- include(infoAlert, {
                title: "Retention Policy (Advanced)",
                infoID: "infoInfluxRetention",
                infoText: "This is only relevant if OctoFarm creates the database initially. The retention policy is how long InfluxDB stores your data for and it's usually best to leave this as default if your not sure. De-activate the default retention policy and fill in your own if required."
                })
                %>
            </div>
            <div class="row">
                <div class="col-12 col-md-4">
                    <%- include(checkBox, {
                    checkboxID: "infRetention",
                    checkboxChecked: serverSettings?.influxExport.retentionPolicy.defaultRet,
                    checkboxLabel: "Default Retention",
                    checkboxOnLabel: "Influx default retention settings will be used",
                    checkboxOffLabel: "Custom retention settings will be used",
                    })
                    %>
                    <hr>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6">
                    <%- include(textInput, {
                    inputID: "infDuration",
                    inputType: "text",
                    inputTag: "Duration",
                    inputPlaceholder: "365d",
                    inputValue: serverSettings.influxExport.retentionPolicy.duration
                    })
                    %>
                    <hr>
                </div>
                <div class="col-12 col-md-6">
                    <%- include(textInput, {
                    inputID: "infReplication",
                    inputType: "number",
                    inputTag: "Replication Ammount",
                    inputPlaceholder: "1",
                    inputValue: serverSettings.influxExport.retentionPolicy.replication
                    })
                    %>
                    <hr>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4 col-lg-5" id="influxParent">
        <%- include(infoAlert, {
        title: "Data Export",
        infoID: "infoInfluxDataExport",
        infoText: "The following data will be exported out of OctoFarm to your influxdb database. Use the buttons below for an example."
        })
        %>
        <div class="hstack gap-2 mb-2">
            <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#livePrinterData" aria-expanded="false" aria-controls="livePrinterData">
                Live Printer Data
            </button>
            <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#finishedPrintData" aria-expanded="false" aria-controls="finishedPrintData">
                Finished Print Data
            </button>
            <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#materialsData" aria-expanded="false" aria-controls="materialsData">
                Materials Data
            </button>
        </div>
        <div class="collapse collapse-horizontal" id="livePrinterData"
             data-bs-parent="#influxParent">
            <%- include(alert, {
            alertType: "info",
            alertMessage: "Printer information is dumped every 5000ms (5 seconds). This will dump a record for each printer in your farm with the information below."
            })
            %>
            <h3>Available Tags:</h3>
            <code>
                name:<br>
                group:<br>
                url:<br>
                state:<br>
                stateCategory:<br>
                host_state:<br>
                websocket_state:<br>
                octoprint_version: <br>
            </code>
            <h3>Information:</h3>
            <code>
                name: 'Printer Name'<br>
                group: 'A group'<br>
                url: 'http://10.50.1.175:5000'<br>
                state: 'Complete'<br>
                host_state: 'Online'<br>
                websocket_state: 'success'<br>
                octoprint_version: '1.8.0rc5'<br>
                state_category: 'Complete'<br>
                current_idle_time: 168870000<br>
                current_active_time: 13920000<br>
                current_offline_time: 0<br>
                storage_free: 21702098944<br>
                storage_total: 41214558208<br>
                timestamp: 1651633430978<br>
                job_resends_transmitted: 82776<br>
                job_resends_count: 4<br>
                job_resends_ratio: 0<br>
                job_progress: 100<br>
                job_file_name: 'Thumbnail_2%_Checker.gcode'<br>
                job_file_display: 'Thumbnail 2% Checker.gcode'<br>
                job_file_path: 'Thumbnail_2%_Checker.gcode'<br>
                job_expected_print_time: 0<br>
                job_expected_print_cost: 0.5432814980499949<br>
                job_expected_total_cost: 0.54<br>
                job_expected_total_volume: 44.87<br>
                job_expected_total_length: 18.66<br>
                job_expected_total_weight: 55.64<br>
                job_expected_total_spool_cost: 0<br>
                job_expected_maintenance_cost: 0.42216309146063397<br>
                job_expected_electricity_cost: 0.12111840658936093<br>
                job_current_z: 16.04<br>
                job_print_time_elapsed: 385<br>
                job_print_time_remaining: 0<br>
                job_average_print_time: 385.5016649959998<br>
                job_last_print_time: 385.5016649959998<br>
                job_thumbnail: 'http://10.50.1.175:5000/plugin/prusaslicerthumbnails/thumbnail/Thumbnail_2%_Checker.png?20220503013230'<br>
                tool0_actual: 180.94<br>
                tool0_target: 0<br>
                bed_actual: 21.78<br>
                bed_target: 0<br>
                chamber_actual: 0<br>
                chamber_target: 0<br>
            </code>
        </div>
        <div class="collapse collapse-horizontal" id="finishedPrintData"
             data-bs-parent="#influxParent">
            <%- include(alert, {
            alertType: "info",
            alertMessage: "History information will be sent when a print is logged as completed or failed (cancelled / error)."
            })
            %>
            <h3>Available Tags:</h3>
            <code>
                printer_name: <br>
                group: <br>
                history_state: <br>
                file_name: <br>
            </code>
            <h3>Information:</h3>
            <code>
                id: '627208b58d771b4f22efadff' <br>
                state: 'Cancelled' <br>
                printer_name: 'Fixed Printer Name' <br>
                start_date: 1651640496731 <br>
                end_date: 1651640501686 <br>
                print_time: 5 <br>
                file_name: 'AshTray Holder Topper - PetG.gcode' <br>
                file_upload_date: 1650561180 <br>
                file_path: 'AshTray Holder Topper - PetG.gcode' <br>
                file_size: 2759245 <br>
                job_estimated_print_time: 5499.021155098422 <br>
                job_actual_print_time: 5 <br>
                cost_printer: 0 <br>
                cost_spool: 0 <br>
                cost_total: 0 <br>
                cost_maintenance: 0.0003630771182141045 <br>
                cost_electricity: 0.00010416666666666667 <br>
                total_volume: 0 <br>
                total_length: 0.24 <br>
                total_weight: 0.72 <br>
                file_average_print_time: 388.6593348096244 <br>
                file_last_print_time: 386.071344932001 <br>
            </code>
        </div>
        <div class="collapse collapse-horizontal" id="materialsData"
             data-bs-parent="#influxParent">
                <%- include(alert, {
                alertType: "info",
                alertMessage: "Materials information is triggered everytime there is a print registered in the database."
                })
                %>
                <%- include(alert, {
                alertType: "warning",
                alertMessage: "If you don't use the Filament Manager plugin or have spool updating enabled, then there will be 0 grams in the 'used_difference' and 'used_spool' fields as it is not tracked without that."
                })
                %>
            <h3>Available Tags:</h3>
            <code>
                state: <br>
                printer_name: <br>
                file_name: <br>
                group: <br>
                spool_manufacturer: 'Eryone',<br>
                spool_material: 'PETG',<br>
            </code>
            <h3>Information:</h3>
            <code>
                name: 'Spooler',<br>
                price: 25,<br>
                weight: 1000,<br>
                used_difference: 15.55, <br>
                used_spool: 225.45, <br>
                temp_offset: 0,<br>
                spool_manufacturer: 'Eryone',<br>
                spool_material: 'PETG',<br>
                spool_density: 1.27,<br>
                spool_diameter: 1.75<br>

            </code>
        </div>
    </div>
</div>
<div class="row">
    <div class="col">
        <div class="d-grid gap-2">
            <button class="btn btn-outline-success" type="button" id="save-influx-changes">Save InfluxDB Changes</button>
        </div>
    </div>
</div>
